<style>
[data-powerbox-target="img"] {
  display: inline-block;
  width: 32px;
  height: 32px
}
[data-powerbox-id] {
  font-size: 18px;
  font-weight: bold;
  color: #000;
  margin-left: 10px;
}
.hidden {
  display: none;
}
</style>

<p><span class="aPowerbox hidden">To unmark this page as not a powerbox, remove</span>
  <span class="notAPowerbox">To mark this page as a powerbox, add</span>
  <code style="font-weight:bold" class="pageHref">???</code>
in your Powerbox Extension settings.</p>

<table class="aPowerbox hidden">
  <tr id="ag1"><th>AG.1</th>
  <td>
    <div data-powerbox-target="img" data-powerbox-id="AG.1">AG.1</div>
    <span data-powerbox-id="AG.1">AG.1</span>
  </td>
  <td><input class="petname" type="text" placeholder="Petname" /></td>
  <td><input class="petimage" type="text" placeholder="Image URL" /></td></tr>
  <tr id="ag2"><th>AG.2</th>
  <td>
    <div data-powerbox-target="img" data-powerbox-id="AG.2">AG.2</div>
    <span data-powerbox-id="AG.2">AG.2</span>
  </td>
  <td><input class="petname" type="text" placeholder="Petname" /></td>
  <td><input class="petimage" type="text" placeholder="Image URL" /></td></tr>
  </tr>
</table>

<script type="text/javascript">
if (typeof powerbox === 'undefined') {
  alert(`\
Powerbox not found.

Please install and activate the Agoric Powerbox extension.
`);
  throw new Error('powerbox not found');
}

powerbox.expandPetdata(petdata => {
  for (const id of [1, 2]) {
    const petname = document.querySelector(`#ag${id} .petname`);
    const petimage = document.querySelector(`#ag${id} .petimage`);
    const { petname: name, petimage: image } = petdata[`AG.${id}`] || {};
    petname.value = name || '';
    petimage.value = image || '';
  }
});

powerbox.isPrivileged().then(isPrivileged => {
  if (isPrivileged) {
    document.querySelectorAll('.aPowerbox').forEach(e => e.classList.remove('hidden'));
    document.querySelectorAll('.notAPowerbox').forEach(e => e.classList.add('hidden'));
  } else {
    document.querySelectorAll('.aPowerbox').forEach(e => e.classList.add('hidden'));
    document.querySelectorAll('.notAPowerbox').forEach(e => e.classList.remove('hidden'));
  }
});
</script>

<script type="module">
import debounce from '../../source/debounce.js';

document.querySelector('.pageHref').textContent = window.location.href;

for (const id of ['1', '2']) {
  const petname = document.querySelector(`#ag${id} .petname`);
  const petimage = document.querySelector(`#ag${id} .petimage`)
  const save = () => {
    window.postMessage({ type: 'POWERBOX_SET_PETDATA', id: `AG.${id}`, petdata: { petname: petname.value, petimage: petimage.value }}, '*');
  };
  petname.addEventListener('keyup', ev => debounce(save, 1000));
  petimage.addEventListener('keyup', ev => debounce(save, 1000));
}
</script>
